var username;

function movetoBottom()
{
        $('#chat').animate({
        scrollTop: $('#chat')[0].scrollHeight}, 50);
}

$(document).ready(function()
{
    username = $('.active').attr('id');

    pullAll();

    $(document).keyup(function(e) {
        if (e.keyCode == 13)
            sendMessage();
    });
});

function pullAll(){
    retrieveChatMessages();
    pullData()
}

function pullData()
{
    retriveNew();
    setTimeout(pullData,1500);
}

function setUsername(id){
    $('#chat-window').empty();
    username = id;
    pullAll();
}

function retrieveChatMessages()
{
    $.post('messages/get', {userId: username}, function(data)
    {
        $.each(data, function(index, value) {
            if(index%2==0){
                $('#chat-window').append('<div class="row"><div class="your-bubble"> '+ escapeHtml(value) +'</div></div>');
                 movetoBottom();
            }else{
                $('#chat-window').append('<div class="row"><div class="their-bubble"> '+ escapeHtml(value) +'</div></div>');
                 movetoBottom();
            }
        });
    });
}

function retriveNew()
{
    $.post('messages/get-new', {userId: username}, function(data)
    {
        $.each(data, function(index, value) {
            if(index%2==0){
                $('#chat-window').append('<div class="row"><div class="your-bubble"> '+ escapeHtml(value) +'</div></div>');
            }else{
                $('#chat-window').append('<div class="row"><div class="their-bubble"> '+ escapeHtml(value) +'</div></div>');
            }
        });
    });
}

 var entityMap = {
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    '"': '&quot;',
    "'": '&#39;',
    "/": '&#x2F;'
  };

  function escapeHtml(string) {
    return String(string).replace(/[&<>"'\/]/g, function (s) {
      return entityMap[s];
    });
  }


function sendMessage()
{
    var text = $('#text').val();

    if (text.length > 0)
    {
        $.post('messages/send', {message: text, userId: username}, function()
        {
            $('#chat-window').append('<div class="row"><div class="your-bubble">'+ escapeHtml(text) +'</div></div>');
            $('#text').val('');
        });
    }
}

$(document).ready(function(){
    movetoBottom();
});
var username;
var plusUsername;
var authPic;
var recipient;
var request;
var offset = 0;
var heroin;
var wait;

function movetoBottom2()
{
   
        var objDiv = document.getElementById("chat");
        var objChunk = document.getElementById("chunk"+offset/20);
        objDiv.scrollTop = objChunk.scrollHeight;
    
}

function movetoBottom()
{
    var objDiv = document.getElementById("chat");
    objDiv.scrollTop = objDiv.scrollHeight;
}


$(document).ready(function()
{
    username = $('.firstUser').attr('id');
    authPic = $('#user-pic').attr('src');
    $("#badge-"+username).text("");

     $('#chat').scroll(function(){
        var scrollTop = parseInt($('#chat').scrollTop());

        if (scrollTop == 0) {
            if(wait){
                retrieveChatMessages();
            }
        }
    });

    pullAll();

    $(document).keyup(function(e) {

        if (e.keyCode == 13)
            sendMessage();
    });

    $( "#send-message" ).click(function() {
        var text = $('#text-new').val();

        if (text.length > 0)
        {
            $.post( 'messages/send', {message: text, userId: recipient, _token: _token}, function()
            {
                window.location = "/messages";
            });
        }
    });

});


function pullAll(){
    retrieveChatMessages();
    pullData();
}

function pullData()
{
    retriveNew();
    request = setTimeout(pullData,1000);
}

function setUsername(id){
    wait = false;
    offset=0;
    $('#chat-window').empty();
    username = id;
    $("#badge-"+username).text("");
    clearTimeout(request);
    request2.abort();
    pullAll();
}

function setRecipient(id){
    recipient = id;
}

function retrieveChatMessages()
{
   request2 = $.post('messages/get', {userId: username, offset: offset , heroin: heroin, _token: _token}, function(data)
    {
        $('#chat-window').prepend('<div id="chunk'+ offset/20 +'"></div>');
        $.each(data, function(index, value) {
            var thumb = value['pic'].substr(0,value['pic'].length-4) + '-100x100' + value['pic'].substr(value['pic'].length-4, value['pic'].length);
            if(value['sender'] == 0){
                   $('#chunk'+offset/20).append('<div class="your row"><img class="small-profile" src="' + base_url  + '/img/' + value['id'] +'/' + thumb +'"><div class="your-bubble"> '+ escapeHtml(value['message']) +'</div></div>');  

            }else{
                    $('#chunk'+offset/20).append('<div class="their row"><img class="small-profile" src="' + base_url  + '/img/' + value['id'] +'/' + thumb +'"><div class="their-bubble">  '+ escapeHtml(value['message']) +'</div></div>');  
            }
        });

        movetoBottom2();

        if(offset/20==0){
            movetoBottom();
        }

        offset+=20;
        wait = true;

    });
}

function retriveNew()
{
    $.post('messages/get-new', {userId: username, _token: _token}, function(data)
    {
        $.each(data, function(index, value) {
            var thumb= value['pic'].substr(0,value['pic'].length-4) + '-100x100' + value['pic'].substr(value['pic'].length-4, value['pic'].length);
            $('#chat-window').append('<div class="their row"><img class="small-profile" src="' + base_url + '/img/' + value['id'] +'/' + thumb +'"><div class="their-bubble">  '+ escapeHtml(value['message']) +'</div></div>');  


            movetoBottom();
        });
    });
}

 var entityMap = {
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    '"': '&quot;',
    "'": '&#39;',
    "/": '&#x2F;'
  };

  function escapeHtml(string) {
    return String(string).replace(/[&<>"'\/]/g, function (s) {
      return entityMap[s];
    });
  }


function sendMessage()
{
    var text = $('#text').val();

    if (text.length > 0)
    {
        $.post('messages/send', {message: text, userId: username, _token: _token}, function()
        {
            $('#chat-window').append('<div class="your row"><img class="small-profile" src="' + authPic + '"><div class="your-bubble">' + escapeHtml(text) +'</div></div>');
            $('#text').val('');
            movetoBottom()
        });
    }
}



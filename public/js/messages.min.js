var username;
var authPic;

function movetoBottom()
{
        $('#chat').animate({
        scrollTop: $('#chat')[0].scrollHeight}, 100);
}

$(document).ready(function()
{
    username = $('.active').attr('id');
    authPic = $('#user-pic').attr('src');

    pullAll();

    $(document).keyup(function(e) {
        if (e.keyCode == 13)
            sendMessage();
    });
});

function pullAll(){
    retrieveChatMessages();
    pullData()
}

function pullData()
{
    retriveNew();
    setTimeout(pullData,3000);
}

function setUsername(id){
    $('#chat-window').empty();
    username = id;
    pullAll();
}

function retrieveChatMessages()
{
    $.post('messages/get', {userId: username}, function(data)
    {
        $.each(data, function(index, value) {
            var thumb= value['pic'].substr(0,value['pic'].length-4) + '-100x100' + value['pic'].substr(value['pic'].length-4, value['pic'].length);
            if(value['sender'] == 0){
                   $('#chat-window').append('<div class="row"><div class="your-bubble"> <img class="small-profile" src="http://localhost:8000/img/' + value['id'] +'/' + thumb +'"> '+ escapeHtml(value['message']) +'</div></div>');  

            }else{
                    $('#chat-window').append('<div class="row"><div class="their-bubble"> <img class="small-profile" src="http://localhost:8000/img/' + value['id'] +'/' + thumb +'"> '+ escapeHtml(value['message']) +'</div></div>');  
            }

            movetoBottom();
        });
    });
}

function retriveNew()
{
    $.post('messages/get-new', {userId: username}, function(data)
    {
        $.each(data, function(index, value) {
            var thumb= value['pic'].substr(0,value['pic'].length-4) + '-100x100' + value['pic'].substr(value['pic'].length-4, value['pic'].length);
            $('#chat-window').append('<div class="row"><div class="their-bubble"> <img class="small-profile" src="http://localhost:8000/img/' + value['id'] +'/' + thumb +'"> '+ escapeHtml(value['message']) +'</div></div>');  


            movetoBottom();
        });
    });
}

 var entityMap = {
    "&": "&amp;",
    "<": "&lt;",
    ">": "&gt;",
    '"': '&quot;',
    "'": '&#39;',
    "/": '&#x2F;'
  };

  function escapeHtml(string) {
    return String(string).replace(/[&<>"'\/]/g, function (s) {
      return entityMap[s];
    });
  }


function sendMessage()
{
    var text = $('#text').val();

    if (text.length > 0)
    {
        $.post('messages/send', {message: text, userId: username}, function()
        {
            $('#chat-window').append('<div class="row"><div class="your-bubble"> <img class="small-profile" src="' + authPic + '">' + escapeHtml(text) +'</div></div>');
            $('#text').val('');
        });
    }
}

$(document).ready(function(){
    movetoBottom();
});